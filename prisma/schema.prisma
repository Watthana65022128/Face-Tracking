
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String
  title       String   
  firstName   String
  lastName    String
  studentId   String?  @unique
  phoneNumber String?  // เบอร์โทรศัพท์
  faceData    String?  // Base64 encoded face template for 2FA
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  sessions    TrackingSession[]
  
  @@map("users")
}

model TrackingSession {
  id            String    @id @default(cuid())
  userId        String
  sessionName   String?   // ชื่อการสอบ/เซสชัน
  startTime     DateTime  @default(now())
  endTime       DateTime?
  totalDuration Int?      // milliseconds
  
  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  trackingLogs  TrackingLog[]
  statistics    SessionStatistics?
  
  @@map("tracking_sessions")
}

model TrackingLog {
  id              String          @id @default(cuid())
  sessionId       String
  detectionType   DetectionType
  detectionData   Json            // Flexible JSON data for different detection types
  confidence      Float?          // Confidence level (0-1)
  
  // Relations
  session         TrackingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@map("tracking_logs")
  @@index([sessionId])
  @@index([detectionType])
}

enum DetectionType {
  EYE_MOVEMENT
  MOUTH_MOVEMENT
  FACE_ORIENTATION
  FACE_DETECTION_LOSS
  DISTANCE_VIOLATION
}

model SessionStatistics {
  id                    String   @id @default(cuid())
  sessionId             String   @unique
  
  // === FACE TRACKING STATS (Active) ===
  // Face orientation tracking (LEFT/RIGHT/UP/DOWN)
  faceOrientationsByDirection Json   // {"LEFT": 10, "RIGHT": 15, "UP": 5, "DOWN": 8}
  timeOffScreen         Int      @default(0) // milliseconds - เวลารวมที่หันหน้าออกจากจอ
  
  // Face detection loss tracking
  faceDetectionLoss     Int      @default(0) // จำนวนครั้งที่สูญเสียการตรวจจับใบหน้า
  totalLossTime         Int      @default(0) // milliseconds - เวลารวมที่สูญเสียการตรวจจับ
  
  // Face orientation statistics
  avgFaceOrientation    Json     // {"totalEvents": 25, "centerTime": 1200, "sessionStartTime": "14:30:00"}
  
  // === FUTURE FEATURES (Commented out for Phase 2-3) ===
  // Eye gaze tracking stats (Phase 3)
  // totalEyeMovements     Int      @default(0)
  // avgGazeDeviation      Float?
  
  // Mouth movement tracking stats (Phase 2)  
  // totalMouthMovements   Int      @default(0)
  // mouthMovementDuration Int      @default(0) // milliseconds
  // speakingDetected      Int      @default(0)
  
  // Distance tracking stats (Future)
  // distanceViolations    Int      @default(0)
  // totalDistanceViolationTime Int @default(0) // milliseconds
  // avgEstimatedDistance  Float?   // average distance in cm
  
  calculatedAt          DateTime @default(now())
  
  // Relations
  session               TrackingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@map("session_statistics")
}
        